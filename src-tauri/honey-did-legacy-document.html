<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>honey-did - Legacy Document</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; line-height: 1.6; background: #f5f5f5; color: #333; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .lock-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; }
        .lock-icon { font-size: 4rem; margin-bottom: 1rem; }
        .lock-title { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .lock-subtitle { color: #666; margin-bottom: 2rem; }
        .password-form { display: flex; flex-direction: column; gap: 1rem; width: 100%; max-width: 300px; }
        .password-input { padding: 12px; font-size: 1rem; border: 2px solid #ddd; border-radius: 8px; text-align: center; }
        .password-input:focus { outline: none; border-color: #007bff; }
        .unlock-btn { padding: 12px 24px; font-size: 1rem; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; }
        .unlock-btn:hover { background: #0056b3; }
        .error { color: #dc3545; margin-top: 1rem; }
        .content { display: none; }
        .content.visible { display: block; }
        .header { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header-title { font-size: 1.5rem; }
        .toolbar { display: flex; gap: 1rem; margin-top: 1rem; }
        .search-input { flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; }
        .print-btn { padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .toc { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .toc-title { font-weight: bold; margin-bottom: 1rem; }
        .toc-list { list-style: none; }
        .toc-list li { margin: 0.5rem 0; }
        .toc-list a { color: #007bff; text-decoration: none; }
        .toc-list a:hover { text-decoration: underline; }
        .section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .section-title { font-size: 1.25rem; border-bottom: 2px solid #007bff; padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .item { background: #f8f9fa; padding: 15px; border-radius: 4px; margin-bottom: 10px; }
        .item-title { font-weight: bold; margin-bottom: 0.5rem; }
        .item-detail { color: #666; font-size: 0.9rem; }
        .notes { background: #fff3cd; padding: 10px; border-radius: 4px; margin-top: 1rem; font-style: italic; }
        .highlight { background: yellow; }
        @media print { .toolbar, .toc { display: none; } .section { break-inside: avoid; } }
    </style>
</head>
<body>
    <div id="lockScreen" class="lock-screen">
        <div class="lock-icon">ðŸ”’</div>
        <h1 class="lock-title">honey-did</h1>
        <p class="lock-subtitle">This file was created by <br>to help you in their absence.</p>
        <form class="password-form" onsubmit="return unlock(event)">
            <input type="password" id="passphrase" class="password-input" placeholder="Enter passphrase" autofocus>
            <button type="submit" class="unlock-btn">Unlock</button>
        </form>
        <p id="error" class="error" style="display: none;"></p>
    </div>
    <div id="content" class="content">
        <div class="container" id="documentContent"></div>
    </div>
    <script>
        const ENCRYPTED_DATA = {"salt":"ZWC9vmq503Nlw0CFKtf9Dw==","nonce":"orsAoJ0rjD+4IV3V","ciphertext":"ILpOUBTUYJh97gSg3kt34CyY1QCCUZXcuH1f4w1nWbdOi8yWoElrbSoHFgAvyxqYD8d4QWRBnEdcPZwTxGLTM3zZqxJViiIGge5MebH6fsfyyhHR5H8wkKFDkdWmymGtMJtwfe49+MUl3gG1FSB1LQx5zGC2DrkwF5aDi9ZaQz3rw4mwLsPzJJFu9ZT9AjbyWCAcTi9KSM7NM4PHZb5onY5d7ZvqRLKikRej0gMaiQPYZvp0qeYqyJvhC7MfYzq5y7Dfd5Q/lukFFfPjL9966qAcA7GFdjuPcEU3h90KaS6MAAYWekPny3S1G4IZy2+HWAfDj+6oMMoJO4SPcycela32hSwXASyL4egu28NiW9x0TKpOFx+uAFQqByM6giSl9CAWevvoSSUoV6D+xkNlGS9X315BM7VZwG7Vk9ULAbf3f+N7wVKQCIySQx0xjwMAXT/nJW2a+ZlYTP9sxT85R5Osm0c0srpoI20+zFi/N42W882udXAeLWu4+ywd8ZPDuE/L6kSJsVmuZVEG0wmwliEGer04Ng0lnTCqZxIfU8Ttw7PZRcmcIH5jwK/lg8h4eIgy3GcnUUBpvA5EXsh/az8CNHLhdntgzSjeZ/P8XirfNH6Si21/7SOirXv/AWciZFnWpiDTvdPtnZou6gA77HUoUOvDowT7Wb4RfHF79UrEU9DHBKhMCo3sYb+90yLQbjI1QMPd/kBkPsDGP5V1AtBx3KUHGVH9HgOUU5BaPt7lpf4QrNKXNUIaIyJIBSFd1LbQ6pPuVdYOj+sbwFAe/16SNgHE78cTlXUkkIN4CYb/G9JRdVNeAtXdHSS+iu1P7LtT8wVTfj8/3so5WWtA7WpvwiFWmRQqTotku2cMNsNrInm52xmQyqlyIgakepxVP22xhNjqxL3QN8i6SB8PkSq6dtUJG7FTXsDvS48/zlqMedM0HAxatVcq7pzQTZHEYgWw11B4aSo2k5ZQiPVs5xZdcCeyLkOV/o26pEo85USDk3cq9+AzL/LZl3wxVfUyU9innPveVNwuNRc082IPVHQVZA3FfN7iKu/N49xayXbrwVmYfBYnzzsLXerJO/kv9tG5xYiDMt+RMgBKqeuHlbSdoasgFbvynBHGxsagjwlMv3/LUgMvDxUAszm6vRWVOhLwgRClwp5/4542EzB8tsv6fnjdGxinMSJ7xAjHmqqdCCThrZIAiuQ3ioE54HoUaWDdV3fRspmLTr9o5A3dpJNAComP4LOUC2fRi9PgtOozC7WAOL8q9cSgPaIj33Z0sUoR42GYxVJ0aDys6h5xkI4xtz76cfSRYUxbzxXut/GG1//ch+70IBfu+p+8Tl4fdB7x77o6rNw1eZOR0cdyQ+AMd3CQlIldckFvC+GV8Cnl3IfPUyMR/s7THjMUYl18p1BmGnDzKb787hA0cgfnHK4QNSF8IKSWHUrDJSNfRxu5rYeC2A5oH9C+qJ6X1sWX2Q=="};
        const PBKDF2_ITERATIONS = 600000;

        async function deriveKey(passphrase, salt) {
            const encoder = new TextEncoder();
            const keyMaterial = await crypto.subtle.importKey(
                'raw', encoder.encode(passphrase), 'PBKDF2', false, ['deriveKey']
            );
            return await crypto.subtle.deriveKey(
                { name: 'PBKDF2', salt: salt, iterations: PBKDF2_ITERATIONS, hash: 'SHA-256' },
                keyMaterial,
                { name: 'AES-GCM', length: 256 },
                false,
                ['decrypt']
            );
        }

        async function unlock(e) {
            e.preventDefault();
            const passphrase = document.getElementById('passphrase').value;
            const errorEl = document.getElementById('error');
            const unlockBtn = document.querySelector('.unlock-btn');

            if (!passphrase) {
                errorEl.textContent = 'Please enter a passphrase.';
                errorEl.style.display = 'block';
                return false;
            }

            unlockBtn.textContent = 'Decrypting...';
            unlockBtn.disabled = true;
            errorEl.style.display = 'none';

            try {
                // Decode the base64 encrypted data
                const salt = Uint8Array.from(atob(ENCRYPTED_DATA.salt), c => c.charCodeAt(0));
                const nonce = Uint8Array.from(atob(ENCRYPTED_DATA.nonce), c => c.charCodeAt(0));
                const ciphertext = Uint8Array.from(atob(ENCRYPTED_DATA.ciphertext), c => c.charCodeAt(0));

                // Derive key using PBKDF2
                const key = await deriveKey(passphrase, salt);

                // Decrypt using AES-GCM
                const decrypted = await crypto.subtle.decrypt(
                    { name: 'AES-GCM', iv: nonce },
                    key,
                    ciphertext
                );

                // Decode the decrypted data as UTF-8 JSON
                const decoder = new TextDecoder();
                const jsonString = decoder.decode(decrypted);
                const data = JSON.parse(jsonString);

                // Render the document
                renderDocument(data);

            } catch (err) {
                console.error('Decryption failed:', err);
                errorEl.textContent = 'Incorrect passphrase. Please try again.';
                errorEl.style.display = 'block';
                unlockBtn.textContent = 'Unlock';
                unlockBtn.disabled = false;
            }

            return false;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function renderContact(contact) {
            if (!contact || !contact.name) return '';
            let html = '<div class="contact-info">';
            if (contact.name) html += '<div><strong>' + escapeHtml(contact.name) + '</strong></div>';
            if (contact.relationship) html += '<div>' + escapeHtml(contact.relationship) + '</div>';
            if (contact.phone) html += '<div>Phone: ' + escapeHtml(contact.phone) + '</div>';
            if (contact.email) html += '<div>Email: ' + escapeHtml(contact.email) + '</div>';
            if (contact.notes) html += '<div class="notes">' + escapeHtml(contact.notes) + '</div>';
            html += '</div>';
            return html;
        }

        function renderSection(title, id, content) {
            if (!content) return '';
            return '<div class="section" id="' + id + '"><h2 class="section-title">' + escapeHtml(title) + '</h2>' + content + '</div>';
        }

        function renderDocument(data) {
            const container = document.getElementById('documentContent');
            let html = '';

            // Header
            html += '<div class="header"><h1 class="header-title">Legacy Document</h1>';
            if (data.meta && data.meta.creator_name) {
                html += '<p>Prepared by ' + escapeHtml(data.meta.creator_name) + '</p>';
            }
            html += '<div class="toolbar">';
            html += '<input type="text" id="searchInput" class="search-input" placeholder="Search..." oninput="search(this.value)">';
            html += '<button class="print-btn" onclick="window.print()">Print</button>';
            html += '</div></div>';

            // Table of Contents
            html += '<div class="toc"><div class="toc-title">Contents</div><ul class="toc-list">';
            const sections = ['financial', 'insurance', 'bills', 'property', 'legal', 'digital', 'household', 'personal', 'contacts', 'medical', 'pets'];
            const sectionLabels = {'financial': 'Financial', 'insurance': 'Insurance', 'bills': 'Bills', 'property': 'Property', 'legal': 'Legal', 'digital': 'Digital Life', 'household': 'Household', 'personal': 'Personal', 'contacts': 'Contacts', 'medical': 'Medical', 'pets': 'Pets'};
            sections.forEach(s => {
                html += '<li><a href="#' + s + '">' + sectionLabels[s] + '</a></li>';
            });
            html += '</ul></div>';

            // Financial Section
            if (data.financial) {
                let content = '';
                if (data.financial.bank_accounts && data.financial.bank_accounts.length) {
                    content += '<h3>Bank Accounts</h3>';
                    data.financial.bank_accounts.forEach(a => {
                        content += '<div class="item"><div class="item-title">' + escapeHtml(a.name) + '</div>';
                        content += '<div class="item-detail">Institution: ' + escapeHtml(a.institution) + '</div>';
                        content += '<div class="item-detail">Type: ' + escapeHtml(a.account_type) + '</div>';
                        if (a.notes) content += '<div class="notes">' + escapeHtml(a.notes) + '</div>';
                        content += '</div>';
                    });
                }
                if (data.financial.credit_cards && data.financial.credit_cards.length) {
                    content += '<h3>Credit Cards</h3>';
                    data.financial.credit_cards.forEach(c => {
                        content += '<div class="item"><div class="item-title">' + escapeHtml(c.name) + '</div>';
                        content += '<div class="item-detail">Issuer: ' + escapeHtml(c.issuer) + '</div>';
                        if (c.notes) content += '<div class="notes">' + escapeHtml(c.notes) + '</div>';
                        content += '</div>';
                    });
                }
                if (data.financial.investments && data.financial.investments.length) {
                    content += '<h3>Investments</h3>';
                    data.financial.investments.forEach(i => {
                        content += '<div class="item"><div class="item-title">' + escapeHtml(i.name) + '</div>';
                        content += '<div class="item-detail">Type: ' + escapeHtml(i.account_type) + '</div>';
                        content += '<div class="item-detail">Institution: ' + escapeHtml(i.institution) + '</div>';
                        if (i.notes) content += '<div class="notes">' + escapeHtml(i.notes) + '</div>';
                        content += '</div>';
                    });
                }
                if (data.financial.debts && data.financial.debts.length) {
                    content += '<h3>Debts</h3>';
                    data.financial.debts.forEach(d => {
                        content += '<div class="item"><div class="item-title">' + escapeHtml(d.name) + '</div>';
                        content += '<div class="item-detail">Lender: ' + escapeHtml(d.lender) + '</div>';
                        if (d.notes) content += '<div class="notes">' + escapeHtml(d.notes) + '</div>';
                        content += '</div>';
                    });
                }
                if (data.financial.notes) content += '<div class="notes">' + escapeHtml(data.financial.notes) + '</div>';
                html += renderSection('Financial Information', 'financial', content);
            }

            // Insurance Section
            if (data.insurance && data.insurance.policies && data.insurance.policies.length) {
                let content = '';
                data.insurance.policies.forEach(p => {
                    content += '<div class="item"><div class="item-title">' + escapeHtml(p.policy_type) + '</div>';
                    content += '<div class="item-detail">Provider: ' + escapeHtml(p.provider) + '</div>';
                    content += '<div class="item-detail">Policy #: ' + escapeHtml(p.policy_number) + '</div>';
                    if (p.contact) content += '<div class="item-detail">Contact: ' + escapeHtml(p.contact) + '</div>';
                    if (p.notes) content += '<div class="notes">' + escapeHtml(p.notes) + '</div>';
                    content += '</div>';
                });
                if (data.insurance.notes) content += '<div class="notes">' + escapeHtml(data.insurance.notes) + '</div>';
                html += renderSection('Insurance', 'insurance', content);
            }

            // Bills Section
            if (data.bills && data.bills.bills && data.bills.bills.length) {
                let content = '';
                data.bills.bills.forEach(b => {
                    content += '<div class="item"><div class="item-title">' + escapeHtml(b.name) + '</div>';
                    content += '<div class="item-detail">Provider: ' + escapeHtml(b.provider) + '</div>';
                    content += '<div class="item-detail">Amount: ' + escapeHtml(b.amount) + '</div>';
                    content += '<div class="item-detail">Due Day: ' + escapeHtml(b.due_day) + '</div>';
                    content += '<div class="item-detail">Auto-pay: ' + (b.autopay ? 'Yes' : 'No') + '</div>';
                    if (b.notes) content += '<div class="notes">' + escapeHtml(b.notes) + '</div>';
                    content += '</div>';
                });
                if (data.bills.notes) content += '<div class="notes">' + escapeHtml(data.bills.notes) + '</div>';
                html += renderSection('Bills', 'bills', content);
            }

            // Property Section
            if (data.property) {
                let content = '';
                if (data.property.properties && data.property.properties.length) {
                    content += '<h3>Properties</h3>';
                    data.property.properties.forEach(p => {
                        content += '<div class="item"><div class="item-title">' + escapeHtml(p.name) + '</div>';
                        content += '<div class="item-detail">Address: ' + escapeHtml(p.address) + '</div>';
                        if (p.notes) content += '<div class="notes">' + escapeHtml(p.notes) + '</div>';
                        content += '</div>';
                    });
                }
                if (data.property.vehicles && data.property.vehicles.length) {
                    content += '<h3>Vehicles</h3>';
                    data.property.vehicles.forEach(v => {
                        content += '<div class="item"><div class="item-title">' + escapeHtml(v.name) + '</div>';
                        content += '<div class="item-detail">' + escapeHtml(v.details) + '</div>';
                        if (v.notes) content += '<div class="notes">' + escapeHtml(v.notes) + '</div>';
                        content += '</div>';
                    });
                }
                if (data.property.valuables && data.property.valuables.length) {
                    content += '<h3>Valuables</h3>';
                    data.property.valuables.forEach(v => {
                        content += '<div class="item"><div class="item-title">' + escapeHtml(v.name) + '</div>';
                        content += '<div class="item-detail">Location: ' + escapeHtml(v.location) + '</div>';
                        if (v.notes) content += '<div class="notes">' + escapeHtml(v.notes) + '</div>';
                        content += '</div>';
                    });
                }
                if (data.property.notes) content += '<div class="notes">' + escapeHtml(data.property.notes) + '</div>';
                html += renderSection('Property', 'property', content);
            }

            // Legal Section
            if (data.legal) {
                let content = '';
                if (data.legal.will_location) content += '<div class="item-detail"><strong>Will Location:</strong> ' + escapeHtml(data.legal.will_location) + '</div>';
                if (data.legal.power_of_attorney) content += '<div class="item-detail"><strong>Power of Attorney:</strong> ' + escapeHtml(data.legal.power_of_attorney) + '</div>';
                if (data.legal.attorney && data.legal.attorney.name) {
                    content += '<h3>Attorney</h3>' + renderContact(data.legal.attorney);
                }
                if (data.legal.trusts && data.legal.trusts.length) {
                    content += '<h3>Trusts</h3>';
                    data.legal.trusts.forEach(t => {
                        content += '<div class="item"><div class="item-title">' + escapeHtml(t.name) + '</div>';
                        content += '<div class="item-detail">Trustee: ' + escapeHtml(t.trustee) + '</div>';
                        if (t.notes) content += '<div class="notes">' + escapeHtml(t.notes) + '</div>';
                        content += '</div>';
                    });
                }
                if (data.legal.notes) content += '<div class="notes">' + escapeHtml(data.legal.notes) + '</div>';
                html += renderSection('Legal Documents', 'legal', content);
            }

            // Digital Section
            if (data.digital) {
                let content = '';
                if (data.digital.password_manager && data.digital.password_manager.name) {
                    content += '<h3>Password Manager</h3>';
                    content += '<div class="item"><div class="item-title">' + escapeHtml(data.digital.password_manager.name) + '</div>';
                    content += '<div class="item-detail">Hint: ' + escapeHtml(data.digital.password_manager.master_password_hint) + '</div>';
                    content += '<div class="item-detail">Recovery: ' + escapeHtml(data.digital.password_manager.recovery_method) + '</div>';
                    content += '</div>';
                }
                if (data.digital.email_accounts && data.digital.email_accounts.length) {
                    content += '<h3>Email Accounts</h3>';
                    data.digital.email_accounts.forEach(e => {
                        content += '<div class="item"><div class="item-title">' + escapeHtml(e.name) + '</div>';
                        content += '<div class="item-detail">Username: ' + escapeHtml(e.username) + '</div>';
                        if (e.recovery_hint) content += '<div class="item-detail">Recovery: ' + escapeHtml(e.recovery_hint) + '</div>';
                        if (e.notes) content += '<div class="notes">' + escapeHtml(e.notes) + '</div>';
                        content += '</div>';
                    });
                }
                if (data.digital.social_media && data.digital.social_media.length) {
                    content += '<h3>Social Media</h3>';
                    data.digital.social_media.forEach(s => {
                        content += '<div class="item"><div class="item-title">' + escapeHtml(s.name) + '</div>';
                        content += '<div class="item-detail">Username: ' + escapeHtml(s.username) + '</div>';
                        if (s.notes) content += '<div class="notes">' + escapeHtml(s.notes) + '</div>';
                        content += '</div>';
                    });
                }
                if (data.digital.notes) content += '<div class="notes">' + escapeHtml(data.digital.notes) + '</div>';
                html += renderSection('Digital Life', 'digital', content);
            }

            // Household Section
            if (data.household) {
                let content = '';
                if (data.household.maintenance_items && data.household.maintenance_items.length) {
                    content += '<h3>Maintenance</h3>';
                    data.household.maintenance_items.forEach(m => {
                        content += '<div class="item"><div class="item-title">' + escapeHtml(m.name) + '</div>';
                        content += '<div class="item-detail">Frequency: ' + escapeHtml(m.frequency) + '</div>';
                        content += '<div class="item-detail">Last Done: ' + escapeHtml(m.last_done) + '</div>';
                        if (m.notes) content += '<div class="notes">' + escapeHtml(m.notes) + '</div>';
                        content += '</div>';
                    });
                }
                if (data.household.contractors && data.household.contractors.length) {
                    content += '<h3>Contractors</h3>';
                    data.household.contractors.forEach(c => {
                        content += '<div class="item">' + renderContact(c) + '</div>';
                    });
                }
                if (data.household.how_things_work && data.household.how_things_work.length) {
                    content += '<h3>How Things Work</h3>';
                    data.household.how_things_work.forEach(h => {
                        content += '<div class="item"><div class="item-title">' + escapeHtml(h.name) + '</div>';
                        content += '<div class="item-detail">' + escapeHtml(h.instructions) + '</div>';
                        content += '</div>';
                    });
                }
                if (data.household.notes) content += '<div class="notes">' + escapeHtml(data.household.notes) + '</div>';
                html += renderSection('Household', 'household', content);
            }

            // Personal Section
            if (data.personal) {
                let content = '';
                if (data.personal.funeral_preferences) {
                    content += '<h3>Funeral Preferences</h3><div class="item">' + escapeHtml(data.personal.funeral_preferences) + '</div>';
                }
                if (data.personal.obituary_notes) {
                    content += '<h3>Obituary Notes</h3><div class="item">' + escapeHtml(data.personal.obituary_notes) + '</div>';
                }
                if (data.personal.messages && data.personal.messages.length) {
                    content += '<h3>Personal Messages</h3>';
                    data.personal.messages.forEach(m => {
                        content += '<div class="item"><div class="item-title">To: ' + escapeHtml(m.recipient) + '</div>';
                        content += '<div class="item-detail">' + escapeHtml(m.message) + '</div>';
                        content += '</div>';
                    });
                }
                if (data.personal.notes) content += '<div class="notes">' + escapeHtml(data.personal.notes) + '</div>';
                html += renderSection('Personal Wishes', 'personal', content);
            }

            // Contacts Section
            if (data.contacts) {
                let content = '';
                if (data.contacts.emergency_contacts && data.contacts.emergency_contacts.length) {
                    content += '<h3>Emergency Contacts</h3>';
                    data.contacts.emergency_contacts.forEach(c => {
                        content += '<div class="item">' + renderContact(c) + '</div>';
                    });
                }
                if (data.contacts.family && data.contacts.family.length) {
                    content += '<h3>Family</h3>';
                    data.contacts.family.forEach(c => {
                        content += '<div class="item">' + renderContact(c) + '</div>';
                    });
                }
                if (data.contacts.professionals && data.contacts.professionals.length) {
                    content += '<h3>Professional Contacts</h3>';
                    data.contacts.professionals.forEach(c => {
                        content += '<div class="item">' + renderContact(c) + '</div>';
                    });
                }
                if (data.contacts.notes) content += '<div class="notes">' + escapeHtml(data.contacts.notes) + '</div>';
                html += renderSection('Important Contacts', 'contacts', content);
            }

            // Medical Section
            if (data.medical && data.medical.family_members && data.medical.family_members.length) {
                let content = '';
                data.medical.family_members.forEach(m => {
                    content += '<div class="item"><div class="item-title">' + escapeHtml(m.name) + '</div>';
                    if (m.conditions && m.conditions.length) content += '<div class="item-detail"><strong>Conditions:</strong> ' + m.conditions.map(c => escapeHtml(c)).join(', ') + '</div>';
                    if (m.allergies && m.allergies.length) content += '<div class="item-detail"><strong>Allergies:</strong> ' + m.allergies.map(a => escapeHtml(a)).join(', ') + '</div>';
                    if (m.medications && m.medications.length) {
                        content += '<div class="item-detail"><strong>Medications:</strong></div>';
                        m.medications.forEach(med => {
                            content += '<div class="item-detail">&nbsp;&nbsp;' + escapeHtml(med.name) + ' - ' + escapeHtml(med.dosage) + ' (' + escapeHtml(med.frequency) + ')</div>';
                        });
                    }
                    if (m.pharmacy && m.pharmacy.name) content += '<div class="item-detail"><strong>Pharmacy:</strong> ' + escapeHtml(m.pharmacy.name) + ' ' + escapeHtml(m.pharmacy.phone || '') + '</div>';
                    if (m.notes) content += '<div class="notes">' + escapeHtml(m.notes) + '</div>';
                    content += '</div>';
                });
                if (data.medical.notes) content += '<div class="notes">' + escapeHtml(data.medical.notes) + '</div>';
                html += renderSection('Medical Information', 'medical', content);
            }

            // Pets Section
            if (data.pets && data.pets.pets && data.pets.pets.length) {
                let content = '';
                data.pets.pets.forEach(p => {
                    content += '<div class="item"><div class="item-title">' + escapeHtml(p.name) + '</div>';
                    content += '<div class="item-detail">Species: ' + escapeHtml(p.species) + '</div>';
                    content += '<div class="item-detail">Breed: ' + escapeHtml(p.breed) + '</div>';
                    if (p.vet && p.vet.name) content += '<div class="item-detail"><strong>Vet:</strong> ' + escapeHtml(p.vet.name) + ' ' + escapeHtml(p.vet.phone || '') + '</div>';
                    if (p.medications && p.medications.length) {
                        content += '<div class="item-detail"><strong>Medications:</strong></div>';
                        p.medications.forEach(med => {
                            content += '<div class="item-detail">&nbsp;&nbsp;' + escapeHtml(med.name) + ' - ' + escapeHtml(med.dosage) + '</div>';
                        });
                    }
                    if (p.feeding) content += '<div class="item-detail"><strong>Feeding:</strong> ' + escapeHtml(p.feeding) + '</div>';
                    if (p.care_notes) content += '<div class="notes">' + escapeHtml(p.care_notes) + '</div>';
                    content += '</div>';
                });
                if (data.pets.notes) content += '<div class="notes">' + escapeHtml(data.pets.notes) + '</div>';
                html += renderSection('Pets', 'pets', content);
            }

            container.innerHTML = html;
            document.getElementById('lockScreen').style.display = 'none';
            document.getElementById('content').classList.add('visible');
        }

        function search(term) {
            const searchInput = document.getElementById('searchInput');
            const currentValue = searchInput ? searchInput.value : '';
            const content = document.getElementById('documentContent');

            // Remove existing highlights
            content.innerHTML = content.innerHTML.replace(/<mark class="highlight">(.*?)<\/mark>/g, '$1');

            if (term && term.length > 1) {
                const regex = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
                content.innerHTML = content.innerHTML.replace(regex, '<mark class="highlight">$1</mark>');
            }

            // Restore search input focus and value after innerHTML replacement
            const newSearchInput = document.getElementById('searchInput');
            if (newSearchInput) {
                newSearchInput.value = currentValue;
                newSearchInput.focus();
                // Move cursor to end
                newSearchInput.setSelectionRange(currentValue.length, currentValue.length);
            }
        }
    </script>
</body>
</html>